name: Generic_AV_Operational_Workflow
version: "1.3"
description: |
  A robust, production-ready AV operations workflow orchestrated across multiple
  fixed agents. This workflow coordinates Baseline, Intake, Plan, Act,
  Verify, and Learn phases to automate capturing SOPs (from NLP/slash commands)
  into ServiceNow as KB_articles. It creates the KB article in the specified
  knowledge base and returns the article sys_id and URL.

roles:
  Knowledge Curator: "Gathers Data"
  KB SOP Article Writer: "Writes KB Articles from SOP's"
  Orchestrator: "Master Agent/Human executing SOP workflows"
  Support_L1: "AV_Operations_Agent"
  Support_L2: "AV engineer"

agents:
  - BaselineAgent
  - IntakeAgent
  - PlanAgent
  - ActAgent
  - VerifyAgent
  - LearnAgent

# Only ServiceNow MCP is required.
mcp_required:
  - servicenow_mcp

profiles:
  default:
    auto_capture: true
    kb_name: "AV_Knowledgebase"       # target knowledge base name in ServiceNow
    publish_state: "draft"             # or "published" if your instance allows
    SOP_name: ""                       # optional: title override; else derived
    sop_markdown: ""                   # optional: SOP body (markdown)
    sop_yaml: ""                       # optional: SOP in YAML
    sop_json: {}                       # optional: SOP in JSON

steps_by_agent:
  BaselineAgent:
    # Minimal connectivity & KB base lookup (servicenow only).
    - id: ping_servicenow
      call: servicenow_mcp.ping
      args: {}
      evidence: ["json:servicenow_status"]

    - id: resolve_kb_base
      call: servicenow_mcp.get_kb_base
      args:
        name: "$context.kb_name|default:AV_Knowledgebase"
      evidence: ["json:kb_base"]

  IntakeAgent:
    # Normalize the SOP inputs provided by the app/context into a single HTML payload.
    - id: assemble_kb_html_from_sop
      call: servicenow_mcp.prepare_kb_payload
      args:
        sop_title: "$context.SOP_name|default:SOP Knowledge Capture"
        sop_markdown: "$context.sop_markdown"
        sop_yaml: "$context.sop_yaml"
        sop_json: "$context.sop_json"
      evidence:
        - "text:kb_title"
        - "text:kb_html"
        - "json:kb_payload"

  PlanAgent:
    # Keep planning ultra-simple: choose the one path "SOP_to_KB".
    - id: choose_publish_flow
      call: servicenow_mcp.plan_publish
      args:
        flow: "SOP_to_KB"
        state: "$context.publish_state|default:draft"
      evidence: ["json:publish_plan"]

  ActAgent:
    # Create the KB article in the resolved knowledge base.
    - id: create_servicenow_KB_article
      call: servicenow_mcp.create_kb
      args:
        title: "$evidence.kb_title"
        kb_base_sys_id: "$evidence.kb_base.sys_id"
        html: "$evidence.kb_html"
        state: "$context.publish_state|default:draft"
      evidence:
        - "json:kb_creation"           # expected: { sys_id, number, url, state }

  VerifyAgent:
    # Verify we can read back the new article.
    - id: verify_kb_article_exists
      call: servicenow_mcp.get_kb
      args:
        sys_id: "$evidence.kb_creation.sys_id"
      evidence:
        - "json:kb_record"

  LearnAgent:
    # Return a clear, single-line result the UI can surface to the user.
    - id: return_creation_message
      call: servicenow_mcp.result_message
      args:
        message: "KB article created and added to AV_Knowledgebase."
        sys_id: "$evidence.kb_creation.sys_id"
        url: "$evidence.kb_creation.url"
      evidence:
        - "text:kb_result_message"
